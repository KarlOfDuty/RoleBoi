#!/bin/sh
# postinst script for roleboi.
#
# See: dh_installdeb(1).

set -e

# Summary of how this script can be called:
#        * <postinst> 'configure' <most-recently-configured-version>
#        * <old-postinst> 'abort-upgrade' <new version>
#        * <conflictor's-postinst> 'abort-remove' 'in-favour' <package>
#          <new-version>
#        * <postinst> 'abort-remove'
#        * <deconfigured's-postinst> 'abort-deconfigure' 'in-favour'
#          <failed-install-package> <version> 'removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package.


case "$1" in
  configure)
    getent group roleboi > /dev/null || groupadd roleboi
    getent passwd roleboi > /dev/null || useradd -r -m -d /var/lib/roleboi -s /sbin/nologin -g roleboi roleboi
    chmod 400 /etc/roleboi/config.yml
    chmod 555 /usr/bin/roleboi
    chown roleboi:roleboi /etc/roleboi/config.yml
    chown roleboi:roleboi /usr/bin/roleboi
    install -m 700 -o roleboi -g roleboi -d /var/lib/roleboi
    install -m 755 -o roleboi -g roleboi -d /var/log/roleboi

    SYSTEMD_VERSION=$(systemctl --version | awk '{if($1=="systemd" && $2~"^[0-9]"){print $2}}' | head -n 1)
    if [ "$SYSTEMD_VERSION" -lt 253 ]; then
        echo "Systemd version is lower than 253 ($SYSTEMD_VERSION); using legacy service type 'notify' instead of 'notify-reload'"
        sed -i 's/^Type=notify-reload$/Type=notify/' "/usr/lib/systemd/system/roleboi.service"
    fi

    systemctl daemon-reload
    if [ -f "/tmp/.roleboi-upgrade-stopped-service" ]; then
      systemctl start roleboi.service
      rm "/tmp/.roleboi-upgrade-stopped-service"
    fi
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    systemctl daemon-reload
  ;;

  *)
    echo "postinst called with unknown argument '$1'" >&2
    exit 1
  ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
